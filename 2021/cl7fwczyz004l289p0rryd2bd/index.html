<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Nginx从入门到实践 | 我的怪兽猫</title><meta name="keywords" content="Nginx"><meta name="author" content="Monster"><meta name="copyright" content="Monster"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="由于跨平台性的设计，Java的指令都是根据栈来设计的">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx从入门到实践">
<meta property="og:url" content="https://47.101.148.21/2021/cl7fwczyz004l289p0rryd2bd/index.html">
<meta property="og:site_name" content="我的怪兽猫">
<meta property="og:description" content="由于跨平台性的设计，Java的指令都是根据栈来设计的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Blog_Cover/Nginx.png">
<meta property="article:published_time" content="2021-05-15T11:25:42.000Z">
<meta property="article:modified_time" content="2022-04-16T07:23:28.000Z">
<meta property="article:author" content="Monster">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Blog_Cover/Nginx.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://47.101.148.21/2021/cl7fwczyz004l289p0rryd2bd/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-9V4FJV65ZE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-9V4FJV65ZE');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx从入门到实践',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2022-04-16 15:23:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/MyStyle/MyStyle.css" media="defer" onload="this.media='all'"/><link rel="stylesheet" href="/css/MyStyle/tagStyle.css" media="defer" onload="this.media='all'"/><link rel="stylesheet" href="/css/MyStyle/JetBrainsMono.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2630408_9i65adv8yet.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">60</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首  页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhangguanli"></i><span> 看文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标  签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分  类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 搞学习</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/pdf/"><i class="fa-fw iconfont icon-pdf"></i><span> PDF</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw iconfont icon-movie"></i><span> Movie</span></a></li><li><a class="site-page child" href="/leetcode/"><i class="fa-fw iconfont icon-leetcode"></i><span> 算  法</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-xiuxi"></i><span> 去娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bangumis/"><i class="fa-fw iconfont icon-bilibili-fill"></i><span> 追番</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw iconfont icon-xiangce1"></i><span> 相册</span></a></li><li><a class="site-page child" href="/book/"><i class="fa-fw iconfont icon-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 异世界</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-wogerenziliao"></i><span> 关  于</span></a></div><div class="menus_item"><a class="site-page" href="/love/"><i class="fa-fw iconfont icon-aixin"></i><span> 我  们</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">我的怪兽猫</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首  页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-wenzhangguanli"></i><span> 看文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标  签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分  类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 搞学习</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/pdf/"><i class="fa-fw iconfont icon-pdf"></i><span> PDF</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw iconfont icon-movie"></i><span> Movie</span></a></li><li><a class="site-page child" href="/leetcode/"><i class="fa-fw iconfont icon-leetcode"></i><span> 算  法</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-xiuxi"></i><span> 去娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/bangumis/"><i class="fa-fw iconfont icon-bilibili-fill"></i><span> 追番</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw iconfont icon-xiangce1"></i><span> 相册</span></a></li><li><a class="site-page child" href="/book/"><i class="fa-fw iconfont icon-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 异世界</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont icon-wogerenziliao"></i><span> 关  于</span></a></div><div class="menus_item"><a class="site-page" href="/love/"><i class="fa-fw iconfont icon-aixin"></i><span> 我  们</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Nginx从入门到实践</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-15T11:25:42.000Z" title="发表于 2021-05-15 19:25:42">2021-05-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-16T07:23:28.000Z" title="更新于 2022-04-16 15:23:28">2022-04-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Nginx/">Nginx</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Nginx从入门到实践"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Nginx从入门到实践"><a href="#Nginx从入门到实践" class="headerlink" title="Nginx从入门到实践"></a>Nginx从入门到实践</h1><h2 id="Nginx基本概念"><a href="#Nginx基本概念" class="headerlink" title="Nginx基本概念"></a>Nginx基本概念</h2><h3 id="什么是Nginx"><a href="#什么是Nginx" class="headerlink" title="什么是Nginx"></a>什么是Nginx</h3><pre class="line-numbers language-tex" data-language="tex"><code class="language-tex">Nginx (&quot;engine x&quot;)是一个高性能的HTTP和反向代理服务器，特点是占有内存少，并发能
力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好
Nginx专为性能优化而开发，性能是其最重要的考量，实现上非常注重效率，能经受高负载
的考验，有报告表明能支持高达50000个并发连接数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><p>​    在客户端（浏览器）配置代理服务器，通过代理服务器进行互联网访问</p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>​    反向代理，其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，再返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器IP地址。</p>
<p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.png"></p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>​    由于单个服务器解决不了，所以我们增加服务器的数量，然后将请求分发到各个服务器上,将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上,将负载分发到不同的服务器，也就是我们所说的负载均衡</p>
<p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png"></p>
<h3 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h3><p>​    为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。</p>
<p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.png"></p>
<h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><p>操作平台 CentOS7</p>
<h3 id="安装相关依赖"><a href="#安装相关依赖" class="headerlink" title="安装相关依赖"></a>安装相关依赖</h3><p>安装 nginx 需要先将官网下载的源码进行编译，编译依赖 gcc 环境，如果没有 gcc 环境，则需要安装</p>
<pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">yum install gcc<span class="token operator">-</span>c<span class="token operator">++</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>PCRE(Perl Compatible Regular Expressions) 是一个Perl库，包括 perl 兼容的正则表达式库。nginx 的 http 模块使用 pcre 来解析正则表达式，所以需要在 linux 上安装 pcre 库，pcre-devel 是使用 pcre 开发的一个二次开发库。nginx也需要此库</p>
<pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">yum install <span class="token operator">-</span>y pcre pcre<span class="token operator">-</span>devel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>zlib 库提供了很多种压缩和解压缩的方式， nginx 使用 zlib 对 http 包的内容进行 gzip ，所以需要在 Centos 上安装 zlib 库</p>
<pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">yum install <span class="token operator">-</span>y zlib zlib<span class="token operator">-</span>devel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>OpenSSL 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及 SSL 协议，并提供丰富的应用程序供测试或其它目的使用。<br>nginx 不仅支持 http 协议，还支持 https（即在ssl协议上传输http），所以需要在 Centos 安装 OpenSSL 库</p>
<pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">yum install <span class="token operator">-</span>y openssl openssl<span class="token operator">-</span>devel<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><blockquote>
<p>a. 直接下载<code>.tar.gz</code>安装包，地址：<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></p>
<p>b. <strong>使用<code>wget</code>命令下载（推荐）</strong>。确保系统已经安装了wget，如果没有安装，执行 yum install wget 安装。</p>
</blockquote>
<pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">wget <span class="token operator">-</span>c https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>org<span class="token operator">/</span>download<span class="token operator">/</span>nginx<span class="token operator">-</span><span class="token number">1.19</span><span class="token number">.0</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">tar <span class="token operator">-</span>zxvf nginx<span class="token operator">-</span><span class="token number">1.19</span><span class="token number">.0</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><pre class="line-numbers language-clike" data-language="clike"><code class="language-clike"><span class="token punctuation">.</span><span class="token operator">/</span>configure
make <span class="token operator">&amp;&amp;</span> make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">ps aux<span class="token operator">|</span>grep nginx #查看是否开启
 
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span>v #查看版本
 
cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx
<span class="token punctuation">.</span><span class="token operator">/</span>nginx #启动
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span>s stop #停止
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span>s quit #停止
<span class="token punctuation">.</span><span class="token operator">/</span>nginx <span class="token operator">-</span>s reload #重载<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h2><p>Nginx 配置文件由三部分组成</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>.              <span class="token comment">#全局块</span>

events <span class="token punctuation">&#123;</span>         <span class="token comment">#events块</span>
   <span class="token punctuation">..</span>.
<span class="token punctuation">&#125;</span>

http      <span class="token comment">#http块</span>
<span class="token punctuation">&#123;</span>
    <span class="token punctuation">..</span>.   <span class="token comment">#http全局块</span>
    server        <span class="token comment">#server块</span>
    <span class="token punctuation">&#123;</span> 
        <span class="token punctuation">..</span>.       <span class="token comment">#server全局块</span>
        location <span class="token punctuation">[</span>PATTERN<span class="token punctuation">]</span>   <span class="token comment">#location块</span>
        <span class="token punctuation">&#123;</span>
            <span class="token punctuation">..</span>.
        <span class="token punctuation">&#125;</span>
        location <span class="token punctuation">[</span>PATTERN<span class="token punctuation">]</span> 
        <span class="token punctuation">&#123;</span>
            <span class="token punctuation">..</span>.
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    server
    <span class="token punctuation">&#123;</span>
      <span class="token punctuation">..</span>.
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">..</span>.     <span class="token comment">#http全局块</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><strong>第一部分 全局块</strong><br>主要设置一些影响 nginx 服务器整体运行的配置指令。<br>比如： worker_processes 1; ， worker_processes 值越大，可以支持的并发处理量就越多。</p>
</li>
<li><p><strong>第二部分 events块</strong><br>events 块涉及的指令主要影响Nginx服务器与用户的网络连接。<br>比如： worker_connections 1024; ，支持的最大连接数。</p>
</li>
<li><p><strong>第三部分 http块</strong><br>http 块又包括 http 全局块和 server 块，是服务器配置中最频繁的部分，包括配置代理、缓存、日志定义等绝大多数功能。</p>
</li>
<li><ul>
<li><strong>server块</strong>：配置虚拟主机的相关参数。</li>
<li><strong>location块</strong>：配置请求路由，以及各种页面的处理情况。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.jpg"></p>
</li>
</ul>
<p>示例配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">########### 每个指令必须有分号结束。#################</span>
<span class="token comment">#user administrator administrators;  #配置用户或者组，默认为nobody nobody。</span>
<span class="token comment">#worker_processes 2;  #允许生成的进程数，默认为1</span>
<span class="token comment">#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址</span>
error_log log/error.log debug<span class="token punctuation">;</span>  <span class="token comment">#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span>
events <span class="token punctuation">&#123;</span>
    accept_mutex on<span class="token punctuation">;</span>   <span class="token comment">#设置网路连接序列化，防止惊群现象发生，默认为on</span>
    multi_accept on<span class="token punctuation">;</span>  <span class="token comment">#设置一个进程是否同时接受多个网络连接，默认为off</span>
    <span class="token comment">#use epoll;      #事件驱动模型，select|poll|kqueue|epoll|resig|/dev/poll|eventport</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>    <span class="token comment">#最大连接数，默认为512</span>
<span class="token punctuation">&#125;</span>
http <span class="token punctuation">&#123;</span>
    include       mime.types<span class="token punctuation">;</span>   <span class="token comment">#文件扩展名与文件类型映射表</span>
    default_type  application/octet-stream<span class="token punctuation">;</span> <span class="token comment">#默认文件类型，默认为text/plain</span>
    <span class="token comment">#access_log off; #取消服务日志    </span>
    log_format myFormat <span class="token string">'<span class="token variable">$remote_addr</span>–<span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] <span class="token variable">$request</span> <span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> <span class="token variable">$http_referer</span> <span class="token variable">$http_user_agent</span> <span class="token variable">$http_x_forwarded_for</span>'</span><span class="token punctuation">;</span> <span class="token comment">#自定义格式</span>
    access_log log/access.log myFormat<span class="token punctuation">;</span>  <span class="token comment">#combined为日志格式的默认值</span>
    sendfile on<span class="token punctuation">;</span>   <span class="token comment">#允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。</span>
    sendfile_max_chunk 100k<span class="token punctuation">;</span>  <span class="token comment">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。</span>
    keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>  <span class="token comment">#连接超时时间，默认为75s，可以在http，server，location块。</span>

    upstream mysvr <span class="token punctuation">&#123;</span>   
      server <span class="token number">127.0</span>.0.1:7878<span class="token punctuation">;</span>
      server <span class="token number">192.168</span>.10.121:3333 backup<span class="token punctuation">;</span>  <span class="token comment">#热备</span>
    <span class="token punctuation">&#125;</span>
    error_page <span class="token number">404</span> https://www.baidu.com<span class="token punctuation">;</span> <span class="token comment">#错误页</span>
    server <span class="token punctuation">&#123;</span>
        keepalive_requests <span class="token number">120</span><span class="token punctuation">;</span> <span class="token comment">#单连接请求上限次数。</span>
        listen       <span class="token number">4545</span><span class="token punctuation">;</span>   <span class="token comment">#监听端口</span>
        server_name  <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span>   <span class="token comment">#监听地址       </span>
        location  ~*^.+$ <span class="token punctuation">&#123;</span>       <span class="token comment">#请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span>
           <span class="token comment">#root path;  #根目录</span>
           <span class="token comment">#index vv.txt;  #设置默认页</span>
           proxy_pass  http://mysvr<span class="token punctuation">;</span>  <span class="token comment">#请求转向mysvr 定义的服务器列表</span>
           deny <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span>  <span class="token comment">#拒绝的ip</span>
           allow <span class="token number">172.18</span>.5.54<span class="token punctuation">;</span> <span class="token comment">#允许的ip           </span>
        <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="安装Tomcat"><a href="#安装Tomcat" class="headerlink" title="安装Tomcat"></a>安装Tomcat</h2><h3 id="①下载安装"><a href="#①下载安装" class="headerlink" title="①下载安装"></a>①下载安装</h3><p><a href="%5Bhttps://tomcat.apache.org%5D(https://tomcat.apache.org/)">tomcat官网</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">tar</span> -zxvf apache-tomcat-10.0.5.tar.gz <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p><strong>bin:</strong> 存放 Tomcat 的 启动、停止 等相关命令<br><strong>lib:</strong> 存放 Tomcat 运行时所需要的 jar 包<br><strong>conf:</strong> Tomcat 配置文件目录<br><strong>logs:</strong> Tomcat 运行日志目录<br><strong>webapps:</strong> 存放运行在 Tomcat 服务器内的应用程序（JavaWeb 应用部署目录）<br><strong>work:</strong> 存放应用程序运行时动态生成的 java 代码和动态编译的 class 文件<br><strong>temp:</strong> 存放 Tomcat 运行时产生的临时文件</p>
</blockquote>
<h3 id="②相关命令"><a href="#②相关命令" class="headerlink" title="②相关命令"></a>②相关命令</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">./startup.sh <span class="token comment">#启动</span>
<span class="token function">netstat</span> -npl <span class="token operator">|</span> <span class="token function">grep</span> :8080 <span class="token comment">#查看端口状态（Tomcat 默认监听 8080 端口）</span>
./shutdown.sh <span class="token comment">#停止</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>注：详细过程可参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/xietansheng/article/details/84405208">linux下安装tomcat</a></p>
<h2 id="实现反向代理"><a href="#实现反向代理" class="headerlink" title="实现反向代理"></a>实现反向代理</h2><h3 id="①启动多个tomcat，分别监听不同的端口"><a href="#①启动多个tomcat，分别监听不同的端口" class="headerlink" title="①启动多个tomcat，分别监听不同的端口"></a>①启动多个tomcat，分别监听不同的端口</h3><p>详细过程可以参考<a target="_blank" rel="noopener" href="https://amos-x.com/index.php/amos/archives/centos7-tomcat-run/">开启多个tomcat</a></p>
<h3 id="②配置nginx"><a href="#②配置nginx" class="headerlink" title="②配置nginx"></a>②配置nginx</h3><p>找到nginx配置文件，进行反向代理配置。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">server <span class="token punctuation">&#123;</span>
        listen       <span class="token number">9001</span><span class="token punctuation">;</span>   
        server_name  <span class="token number">0.0</span>.0.0   <span class="token comment">#监听地址</span>
   
        location  ~ /edu/ <span class="token punctuation">&#123;</span>       
           root html<span class="token punctuation">;</span>  <span class="token comment">#/html目录</span>
           proxy_pass http://127.0.0.1:8081<span class="token punctuation">;</span>  <span class="token comment">#请求转向</span>
           index  index.html index.htm<span class="token punctuation">;</span>      <span class="token comment">#设置默认页       </span>
        <span class="token punctuation">&#125;</span> 
        location  ~ /vod/ <span class="token punctuation">&#123;</span>       
           root html<span class="token punctuation">;</span>  <span class="token comment">#/html目录</span>
           proxy_pass http://127.0.0.1:8081<span class="token punctuation">;</span>  <span class="token comment">#请求转向</span>
           index  index.html index.htm<span class="token punctuation">;</span>      <span class="token comment">#设置默认页       </span>
        <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>开放对外访问的端口号9001</p>
<p>重启nginx服务器，使配置文件生效</p>
<h3 id="③测试"><a href="#③测试" class="headerlink" title="③测试"></a>③测试</h3><p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:9001/edu/">http://127.0.0.1:9001/edu/</a> 直接跳转到127.0.0.1:8081<br>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:9001/vod/">http://127.0.0.1:9001/vod/</a> 直接跳转到127.0.0.1:8082</p>
<blockquote>
<p>Nginx-location相关指令</p>
<p>​    =：用于不含正则表达式的uri前，要求请求字符串与uri严格匹配，如果匹配成功，<br>​    就停止继续向下搜索并立即处理该请求<br>​    <del>：用于表示uri包含正则表达式，并且区分大小写<br>​    ~*：用于表示uri包含正则表达式，并且不区分大小写<br>​    ^</del>：用于不含正则表达式的uri前，要求Nginx服务器找到标识uri和请求字符串匹配度最高的location后，立即使用此location处理请求，而不再使用location块中的正则uri和请求字符串做匹配<br>​    注意: 如果uri包含正则表达式，则必须要有<del>或者</del>*标识。</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 基本语法</span>
location <span class="token punctuation">[</span> <span class="token operator">=</span> <span class="token operator">|</span> ~ <span class="token operator">|</span> ~* <span class="token operator">|</span> ^~<span class="token punctuation">]</span> uri <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="实现负载均衡"><a href="#实现负载均衡" class="headerlink" title="实现负载均衡"></a>实现负载均衡</h2><p><strong>1、实现效果</strong></p>
<blockquote>
<p>(1) 浏览器地址栏输入地址<a target="_blank" rel="noopener" href="http://192.168.xxx.xxx/edu/index.html">http://192.168.xxx.xxx/edu/index.html</a>, 负载均衡效果，平均到8080<br>和8081端口中，</p>
</blockquote>
<h3 id="负载分配策略"><a href="#负载分配策略" class="headerlink" title="负载分配策略"></a>负载分配策略</h3><p>在linux下有Nginx、LVS、 Haproxy 等等服务可以提供负载均衡服务，而且Nginx提供了以下几种分配方式(策略)</p>
<ul>
<li><p><strong>1、轮询(默认)</strong></p>
<p>每个请求按时间顺序逐一分配到不 同的后端服务器，如果后端服务器down掉，能自动剔除</p>
</li>
<li><p><strong>2、weight</strong><br>weight代表权重默认为1,权重越高被分配的客户端越多。<br>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。例如: 。</p>
</li>
<li><p><strong>3、ip hash</strong></p>
<p>每个请求按访问ip的hash结果分配, 这样每个访客固定访问一个后端服务器,可以解诀session的问题。例如:</p>
</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">upstream server pool<span class="token punctuation">&#123;</span>
  ip_ <span class="token builtin class-name">hash</span>
  server <span class="token number">192.168</span>.5.21:80
  server <span class="token number">192.168</span>.5.22:80
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>4、fair (第三方)</strong><br>按后端服务器的响应时间来分配请求，响应时间短的优先分配</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">upstream server_pool 
	server <span class="token number">192.168</span>.5.21:80<span class="token punctuation">;</span>
	server <span class="token number">192.168</span>.5.22:80<span class="token punctuation">;</span>
	fair<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="实现动静分离"><a href="#实现动静分离" class="headerlink" title="实现动静分离"></a>实现动静分离</h2><p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.jpg"></p>
<blockquote>
<p>​    通过location指定不同的后缀名实现不同的请求转发。通过expires参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量。具体Expires定义: 是给一个资源设定一个过期时间，也就是说无需去服务端验证，直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源。(如果经常更新的文件，不建议使用Expires来缓存)，如果设置3d, 表示在这3天之内访问这个URL, 发送一个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码304,如果有修改，则直接从服务器重新下载，返回状态码200。</p>
</blockquote>
<p><strong>2、准备工作</strong></p>
<blockquote>
<p>(1) 在liunx系统中准备静态资源，用于进行访问</p>
<p>/data/image 图片文件夹</p>
<p>/data/www html文件夹</p>
</blockquote>
<p><strong>3、具体配置</strong></p>
<blockquote>
<p>(1) 在nginx配置文件中进行配置</p>
</blockquote>
<pre class="line-numbers language-clike" data-language="clike"><code class="language-clike">location <span class="token operator">/</span>www<span class="token operator">/</span><span class="token punctuation">&#123;</span>
	root <span class="token operator">/</span>data<span class="token operator">/</span><span class="token punctuation">;</span>
	index index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
location <span class="token operator">/</span>image<span class="token operator">/</span><span class="token punctuation">&#123;</span>
	root <span class="token operator">/</span>data<span class="token operator">/</span><span class="token punctuation">;</span>
	autoindex on<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、实际测试</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;localhost&#x2F;www&#x2F;index.html
http:&#x2F;&#x2F;1ocalhost&#x2F;image&#x2F;1.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="实现高可用集群"><a href="#实现高可用集群" class="headerlink" title="实现高可用集群"></a>实现高可用集群</h2><p><strong>1、什么是nginx高可用</strong></p>
<p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E9%AB%98%E5%8F%AF%E7%94%A8.jpg"></p>
<p><strong>2、配置高可用的准备工作</strong></p>
<blockquote>
<p>(1) 需要两台服务器192.168.17.129 和192.168.17.131<br>(2) 在两台服务器安装nginx.<br>(3) 在两合服务器安装keepalived.</p>
</blockquote>
<p><strong>3、在两台服务器安装keepalived</strong><br>使用yum命令进行安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ yum <span class="token function">install</span> keepalived
$ <span class="token function">rpm</span> -q -a keepalived    <span class="token comment">#查看是否已经安装上</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>默认安装路径: /etc/keepalived</p>
<p>安装之后，在etc里面生成目录keepalived, 有配置文件keepalived.conf</p>
<p><strong>4、完成高可用配置(主从配置)</strong></p>
<p>（1）修改keepalived的配置文件<code>keepalived.conf</code>为：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">global_defs <span class="token punctuation">&#123;</span>
	notification_email <span class="token punctuation">&#123;</span>
	  acassen@firewall.loc
	  failover@firewall.loc
	  sysadmin@firewall.loc
	<span class="token punctuation">&#125;</span>
	notification_email_from Alexandre.Cassen@firewall.loc
	smtp_ server <span class="token number">192.168</span>.17.129
	smtp_connect_timeout <span class="token number">30</span>
	router_id LVS_DEVEL	<span class="token comment"># LVS_DEVEL这字段在/etc/hosts文件中看；通过它访问到主机</span>
<span class="token punctuation">&#125;</span>

vrrp_script chk_http_ port <span class="token punctuation">&#123;</span>
	script <span class="token string">"/usr/local/src/nginx_check.sh"</span>
	interval <span class="token number">2</span>   <span class="token comment"># (检测脚本执行的间隔)2s</span>
	weight <span class="token number">2</span>  <span class="token comment">#权重，如果这个脚本检测为真，服务器权重+2</span>
<span class="token punctuation">&#125;</span>

vrrp_instance VI_1 <span class="token punctuation">&#123;</span>
	state BACKUP   <span class="token comment"># 备份服务器上将MASTER 改为BACKUP</span>
	interface ens33 //网卡名称
	virtual_router_id <span class="token number">51</span> <span class="token comment"># 主、备机的virtual_router_id必须相同</span>
	priority <span class="token number">100</span>   <span class="token comment">#主、备机取不同的优先级，主机值较大，备份机值较小</span>
	advert_int <span class="token number">1</span>	<span class="token comment">#每隔1s发送一次心跳</span>
	authentication <span class="token punctuation">&#123;</span>	<span class="token comment"># 校验方式， 类型是密码，密码1111</span>
        auth <span class="token builtin class-name">type</span> PASS
        auth pass <span class="token number">1111</span>
    <span class="token punctuation">&#125;</span>
	virtual_ipaddress <span class="token punctuation">&#123;</span> <span class="token comment"># 虛拟ip</span>
		<span class="token number">192.168</span>.17.50 // VRRP H虛拟ip地址
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>（2）在路径/usr/local/src/ 下新建检测脚本 nginx_check.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token shebang important">#! /bin/bash</span>
<span class="token assign-left variable">A</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx -no-header <span class="token operator">|</span> <span class="token function">wc</span> - <span class="token number">1</span><span class="token variable">`</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$A</span> -eq <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
	/usr/local/nginx/sbin/nginx
	<span class="token function">sleep</span> <span class="token number">2</span>
	<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -C nginx --no-header<span class="token operator">|</span> <span class="token function">wc</span> -1<span class="token variable">`</span></span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
		<span class="token function">killall</span> keepalived
	<span class="token keyword">fi</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 把两台服务器上nginx和keepalived启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ systemctl start keepalived.service		<span class="token comment">#keepalived启动</span>
$ <span class="token function">ps</span> -ef I <span class="token function">grep</span> keepalived		<span class="token comment">#查看keepalived是否启动</span>
$ systemctl stop keepalived.service  <span class="token comment">#keepalived停止</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>5、最终测试</strong></p>
<p>(1) 在浏览器地址栏输入虚拟ip地址192.168.17.50</p>
<p>(2) 把主服务器(192.168.17.129) nginx和keealived停止，再输入192.168.17.50.</p>
<h2 id="Nginx原理解析"><a href="#Nginx原理解析" class="headerlink" title="Nginx原理解析"></a>Nginx原理解析</h2><p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/worker.jpg"></p>
<p>​        Nginx 启动之后，在 Linux 系统中有两个进程，一个为 master，一个为 worker。master 作为管理员不参与任何工作，只负责给多个 worker 分配不同的任务（worker 一般有多个）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> nginx 
root     <span class="token number">20473</span>     <span class="token number">1</span>  <span class="token number">0</span>  <span class="token number">2019</span> ?        00:00:00 nginx: master process /usr/sbin/nginx 
nginx     <span class="token number">4628</span> <span class="token number">20473</span>  <span class="token number">0</span> Jan06 ?        00:00:00 nginx: worker process 
nginx     <span class="token number">4629</span> <span class="token number">20473</span>  <span class="token number">0</span> Jan06 ?        00:00:00 nginx: worker process<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="worker-是如何工作的？"><a href="#worker-是如何工作的？" class="headerlink" title="worker 是如何工作的？"></a>worker 是如何工作的？</h3><p>​        客户端发送一个请求首先要经过 master，管理员收到请求后会将请求通知给 worker，多个 worker 以<strong>争抢</strong>的机制来抢夺任务，得到任务的 worker 会将请求经由 tomcat 等做请求转发、反向代理、访问数据库等（nginx 本身是不直接支持 java 的）。</p>
<p><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Nginx/%E6%9C%BA%E5%88%B6.jpg"></p>
<h3 id="master-workers-的机制的好处"><a href="#master-workers-的机制的好处" class="headerlink" title="master-workers 的机制的好处"></a>master-workers 的机制的好处</h3><ul>
<li>对于每个 worker 进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销，同时在编程以及问题查找时，也会方便很多。</li>
<li>采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master 进程则很快启动新的worker 进程。当然，worker 进程的异常退出，肯定是程序有 bug 了，异常退出，会导致当前 worker 上的所有请求失败，不过不会影响到所有请求，所以降低了风险。</li>
</ul>
<h3 id="设置多少个-worker-合适？"><a href="#设置多少个-worker-合适？" class="headerlink" title="设置多少个 worker 合适？"></a>设置多少个 worker 合适？</h3><p>​        Nginx 和 redis 类似，都采用了 io 多路复用机制，每个 worker 都是一个独立的进程，每个进程里只有一个主线程，通过异步非阻塞的方式来处理请求，每个 worker 的线程可以把一个 cpu 的性能发挥到极致，因此，<strong>worker 数和服务器的 cpu 数相等是最为适宜的</strong>。设少了会浪费 cpu，设多了会造成 cpu 频繁切换上下文带来的损耗</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 设置worker数量</span>
worker.processes <span class="token number">4</span> 

<span class="token comment"># work绑定cpu(4work绑定4cpu)</span>
worker_cpu_affinity 0001 0010 0100 <span class="token number">1000</span>

<span class="token comment"># work绑定cpu (4work绑定8cpu中的4个)</span>
worker_cpu_affinity 0000001 00000010 00000100 00001000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="连接数-worker-connection"><a href="#连接数-worker-connection" class="headerlink" title="连接数 worker_connection"></a>连接数 worker_connection</h3><p>​        这个值是表示每个 worker 进程所能建立连接的最大值，所以，一个 nginx 能建立的最大连接数，应该是 <strong>worker_connections * worker_processes</strong>。当然，这里说的是最大连接数，对于HTTP 请 求 本 地 资 源 来 说 ， 能 够 支 持 的 最 大 并 发 数 量 是 worker_connections * worker_processes，如果是支持 http1.1 的浏览器每次访问要占两个连接，所以普通的静态访问最大并发数是： worker_connections * worker_processes /2，而如果是 HTTP 作 为反向代理来说，最大并发数量应该是 worker_connections * worker_processes/4。因为作为反向代理服务器，每个并发会建立与客户端的连接和与后端服务的连接，会占用两个连接。</p>
<h3 id="两个问题"><a href="#两个问题" class="headerlink" title="两个问题"></a>两个问题</h3><p><strong>发送请求，占用了woker的几个连接数?</strong><br>    2或者4个。</p>
<p><strong>nginx有一个master,有四个woker,每个woker支持最大的连接数1024,支持的最大并发数是多少?</strong><br>    普通的静态访问最大并发数是: worker connections * worker processes /2，<br>    而如果是HTTP作为反向代理来说，最大并发数量应该是worker connections * worker processes/4</p>
<p>知识来源  |   <a target="_blank" rel="noopener" href="http://www.atguigu.com/download_detail.shtml?v=221">尚硅谷Nginx</a></p>
<p>知识整理  |   Monster</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Monster</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://47.101.148.21/2021/cl7fwczyz004l289p0rryd2bd/">https://47.101.148.21/2021/cl7fwczyz004l289p0rryd2bd/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://47.101.148.21" target="_blank">我的怪兽猫</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Blog_Cover/Nginx.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/cl7fwczyw003r289p0ka408ra/"><img class="prev-cover" src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Blog_Cover/12.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Java随机生成姓名、电话等工具类</div></div></a></div><div class="next-post pull-right"><a href="/2021/cl7fwczyo0018289p6h6d004g/"><img class="next-cover" src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Blog_Cover/7.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">虚拟机栈</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Monster</div><div class="author-info__description">山腰的风景很美，然而我还是想到山顶去看看</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">60</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div></div><a class="button--animated" id="card-info-btn" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=1264833435&amp;website=www.oicqzone.com"><i class="iconfont icon-open"></i><span>Link Start</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/MyMonsterCat" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">祝大家新年快乐，虎虎生威~！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5"><span class="toc-text">Nginx从入门到实践</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">Nginx基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFNginx"><span class="toc-text">什么是Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">正向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-text">动静分离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%AE%89%E8%A3%85"><span class="toc-text">Nginx安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-text">安装相关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Nginx"><span class="toc-text">安装Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD"><span class="toc-text">下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%8E%8B"><span class="toc-text">解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-text">启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">Nginx配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Tomcat"><span class="toc-text">安装Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-text">①下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-text">②相关命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">实现反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A0%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AAtomcat%EF%BC%8C%E5%88%86%E5%88%AB%E7%9B%91%E5%90%AC%E4%B8%8D%E5%90%8C%E7%9A%84%E7%AB%AF%E5%8F%A3"><span class="toc-text">①启动多个tomcat，分别监听不同的端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A1%E9%85%8D%E7%BD%AEnginx"><span class="toc-text">②配置nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%91%A2%E6%B5%8B%E8%AF%95"><span class="toc-text">③测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">实现负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-text">负载分配策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-text">实现动静分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-text">实现高可用集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90"><span class="toc-text">Nginx原理解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#worker-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F"><span class="toc-text">worker 是如何工作的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#master-workers-%E7%9A%84%E6%9C%BA%E5%88%B6%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-text">master-workers 的机制的好处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%A4%9A%E5%B0%91%E4%B8%AA-worker-%E5%90%88%E9%80%82%EF%BC%9F"><span class="toc-text">设置多少个 worker 合适？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0-worker-connection"><span class="toc-text">连接数 worker_connection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-text">两个问题</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/cl7fwczzm00b3289pczuf2lwo/" title="软件设计师-操作系统"><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Pic/image-20220301002332267.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="软件设计师-操作系统"/></a><div class="content"><a class="title" href="/2022/cl7fwczzm00b3289pczuf2lwo/" title="软件设计师-操作系统">软件设计师-操作系统</a><time datetime="2022-02-28T16:19:16.000Z" title="发表于 2022-03-01 00:19:16">2022-03-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/cl7fwczyp001i289p7psy3mql/" title="DDD领域驱动设计-4.实践及其他"><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Pic/13236281-3fa098f26ad1664c.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DDD领域驱动设计-4.实践及其他"/></a><div class="content"><a class="title" href="/2022/cl7fwczyp001i289p7psy3mql/" title="DDD领域驱动设计-4.实践及其他">DDD领域驱动设计-4.实践及其他</a><time datetime="2022-02-28T06:44:12.000Z" title="发表于 2022-02-28 14:44:12">2022-02-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/cl7fwczyj000s289pae64fkg8/" title="DDD领域驱动设计-3.分层架构"><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Pic/13236281-3fa098f26ad1664c.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DDD领域驱动设计-3.分层架构"/></a><div class="content"><a class="title" href="/2022/cl7fwczyj000s289pae64fkg8/" title="DDD领域驱动设计-3.分层架构">DDD领域驱动设计-3.分层架构</a><time datetime="2022-02-28T05:02:52.000Z" title="发表于 2022-02-28 13:02:52">2022-02-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/cl7fwczyg000b289pgcz83vb8/" title="DDD领域驱动设计-2.基本概念"><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Pic/13236281-3fa098f26ad1664c.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DDD领域驱动设计-2.基本概念"/></a><div class="content"><a class="title" href="/2022/cl7fwczyg000b289pgcz83vb8/" title="DDD领域驱动设计-2.基本概念">DDD领域驱动设计-2.基本概念</a><time datetime="2022-02-28T04:32:52.000Z" title="发表于 2022-02-28 12:32:52">2022-02-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/cl7fwczyh000h289p72jueu9g/" title="DDD领域驱动设计-1.入门介绍"><img src="https://raw.githubusercontent.com/MyMonsterCat/md_image/main/%E5%9F%BA%E7%A1%80/Pic/13236281-3fa098f26ad1664c.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DDD领域驱动设计-1.入门介绍"/></a><div class="content"><a class="title" href="/2022/cl7fwczyh000h289p72jueu9g/" title="DDD领域驱动设计-1.入门介绍">DDD领域驱动设计-1.入门介绍</a><time datetime="2022-02-28T04:02:52.000Z" title="发表于 2022-02-28 12:02:52">2022-02-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2022 By Monster</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43010402000915"><span> 湘公网安备 43010402000915号 </span></a><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="/img/icp.png"><span>鲁ICP备2021006500号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'gta1kVza0nbBPTle7TavUngV-gzGzoHsz',
      appKey: 'jLVBRdBH7kwXKGX1ihnCyXYj',
      placeholder: '记得留下你的昵称和邮箱，我可以在收到以后快速回复',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '4',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@latest/source/js/issues.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-9V4FJV65ZE', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>