<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://monstercat.cn/sql/mysql/lock/deadlock.html"><meta property="og:site_name" content="MonsterCat"><meta property="og:title" content="MySQL 死锁了，怎么办？"><meta property="og:description" content="说个很早之前自己遇到过数据库死锁问题。 有个业务主要逻辑就是新增订单、修改订单、查询订单等操作。然后因为订单是不能重复的，所以当时在新增订单的时候做了幂等性校验，做法就是在新增订单记录之前，先通过 select ... for update 语句查询订单是否存在，如果不存在才插入订单记录。 而正是因为这样的操作，当业务量很大的时候，就可能会出现死锁。 ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-04T08:37:54.000Z"><meta property="article:author" content="Monster"><meta property="article:modified_time" content="2023-07-04T08:37:54.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"MySQL 死锁了，怎么办？","image":[""],"dateModified":"2023-07-04T08:37:54.000Z","author":[{"@type":"Person","name":"Monster","url":"https://monstercat.cn","email":"1264833435@qq.com"}]}</script><link rel="icon" href="/favicon.png"><title>MySQL 死锁了，怎么办？ | MonsterCat</title><meta name="description" content="说个很早之前自己遇到过数据库死锁问题。 有个业务主要逻辑就是新增订单、修改订单、查询订单等操作。然后因为订单是不能重复的，所以当时在新增订单的时候做了幂等性校验，做法就是在新增订单记录之前，先通过 select ... for update 语句查询订单是否存在，如果不存在才插入订单记录。 而正是因为这样的操作，当业务量很大的时候，就可能会出现死锁。 ...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-dcc89c7c.css" as="style"><link rel="stylesheet" href="/assets/style-dcc89c7c.css">
    <link rel="modulepreload" href="/assets/app-06863dc2.js"><link rel="modulepreload" href="/assets/framework-0ece11a6.js"><link rel="modulepreload" href="/assets/deadlock.html-523354ac.js"><link rel="modulepreload" href="/assets/deadlock.html-2c54db29.js"><link rel="prefetch" href="/assets/index.html-fd0a9c68.js" as="script"><link rel="prefetch" href="/assets/home.html-943744bf.js" as="script"><link rel="prefetch" href="/assets/gitflow.html-ad5453b4.js" as="script"><link rel="prefetch" href="/assets/nginx.html-21a1249d.js" as="script"><link rel="prefetch" href="/assets/uml.html-891beab9.js" as="script"><link rel="prefetch" href="/assets/index.html-ec0a7ce4.js" as="script"><link rel="prefetch" href="/assets/me.html-e6aca247.js" as="script"><link rel="prefetch" href="/assets/update-plan.html-55bbd08f.js" as="script"><link rel="prefetch" href="/assets/2023-June.html-f4c1e3f8.js" as="script"><link rel="prefetch" href="/assets/https.html-8474e8e1.js" as="script"><link rel="prefetch" href="/assets/index.html-271125aa.js" as="script"><link rel="prefetch" href="/assets/jihe-all.html-1cfcb1ef.js" as="script"><link rel="prefetch" href="/assets/jihe-collection.html-50d94e0c.js" as="script"><link rel="prefetch" href="/assets/jihe-map.html-3cc3aea9.js" as="script"><link rel="prefetch" href="/assets/reflex-mechanism.html-669d0c43.js" as="script"><link rel="prefetch" href="/assets/base01.html-a4e638ea.js" as="script"><link rel="prefetch" href="/assets/gc.html-f34a18bb.js" as="script"><link rel="prefetch" href="/assets/jvm-summary.html-b370ced5.js" as="script"><link rel="prefetch" href="/assets/memory-structure.html-7edc4a55.js" as="script"><link rel="prefetch" href="/assets/how_select.html-607abada.js" as="script"><link rel="prefetch" href="/assets/row_format.html-e64d2005.js" as="script"><link rel="prefetch" href="/assets/index.html-4c0bcfb6.js" as="script"><link rel="prefetch" href="/assets/buffer_pool.html-7c4aef5f.js" as="script"><link rel="prefetch" href="/assets/how_to_lock.html-4ee8e3e7.js" as="script"><link rel="prefetch" href="/assets/lock_phantom.html-269be485.js" as="script"><link rel="prefetch" href="/assets/mysql_lock.html-6421982f.js" as="script"><link rel="prefetch" href="/assets/show_lock.html-03ab9774.js" as="script"><link rel="prefetch" href="/assets/update_index.html-323c21ff.js" as="script"><link rel="prefetch" href="/assets/2000w.html-05f2e144.js" as="script"><link rel="prefetch" href="/assets/count.html-b7813b42.js" as="script"><link rel="prefetch" href="/assets/index_interview.html-53275b1c.js" as="script"><link rel="prefetch" href="/assets/index_issue.html-fed11a3b.js" as="script"><link rel="prefetch" href="/assets/index_lose.html-ea944585.js" as="script"><link rel="prefetch" href="/assets/page.html-a356f515.js" as="script"><link rel="prefetch" href="/assets/why_index_chose_bpuls_tree.html-7e63a2f5.js" as="script"><link rel="prefetch" href="/assets/index.html-293fb63d.js" as="script"><link rel="prefetch" href="/assets/how_update.html-b36cd912.js" as="script"><link rel="prefetch" href="/assets/mvcc.html-596bdb5c.js" as="script"><link rel="prefetch" href="/assets/phantom.html-5a98ad30.js" as="script"><link rel="prefetch" href="/assets/404.html-76fe73be.js" as="script"><link rel="prefetch" href="/assets/index.html-fdb692c4.js" as="script"><link rel="prefetch" href="/assets/index.html-08407341.js" as="script"><link rel="prefetch" href="/assets/index.html-def22607.js" as="script"><link rel="prefetch" href="/assets/index.html-e236620b.js" as="script"><link rel="prefetch" href="/assets/index.html-bc100d39.js" as="script"><link rel="prefetch" href="/assets/index.html-f26d1baf.js" as="script"><link rel="prefetch" href="/assets/index.html-abfc31dc.js" as="script"><link rel="prefetch" href="/assets/index.html-8406a70f.js" as="script"><link rel="prefetch" href="/assets/index.html-38706f33.js" as="script"><link rel="prefetch" href="/assets/index.html-dd5b2d42.js" as="script"><link rel="prefetch" href="/assets/index.html-c5df2584.js" as="script"><link rel="prefetch" href="/assets/index.html-a9416e47.js" as="script"><link rel="prefetch" href="/assets/index.html-f867246b.js" as="script"><link rel="prefetch" href="/assets/index.html-c3524e3d.js" as="script"><link rel="prefetch" href="/assets/index.html-41645749.js" as="script"><link rel="prefetch" href="/assets/index.html-0fc7dda5.js" as="script"><link rel="prefetch" href="/assets/index.html-ea902f75.js" as="script"><link rel="prefetch" href="/assets/index.html-731f55cc.js" as="script"><link rel="prefetch" href="/assets/index.html-de03ea70.js" as="script"><link rel="prefetch" href="/assets/index.html-26c6239c.js" as="script"><link rel="prefetch" href="/assets/home.html-925933bd.js" as="script"><link rel="prefetch" href="/assets/gitflow.html-61871c03.js" as="script"><link rel="prefetch" href="/assets/nginx.html-540e12f6.js" as="script"><link rel="prefetch" href="/assets/uml.html-16095643.js" as="script"><link rel="prefetch" href="/assets/index.html-6abc425a.js" as="script"><link rel="prefetch" href="/assets/me.html-f7e93ea3.js" as="script"><link rel="prefetch" href="/assets/update-plan.html-92f312f0.js" as="script"><link rel="prefetch" href="/assets/2023-June.html-4f19dffa.js" as="script"><link rel="prefetch" href="/assets/https.html-bff629b8.js" as="script"><link rel="prefetch" href="/assets/index.html-4049c970.js" as="script"><link rel="prefetch" href="/assets/jihe-all.html-e7d36ed4.js" as="script"><link rel="prefetch" href="/assets/jihe-collection.html-793180f3.js" as="script"><link rel="prefetch" href="/assets/jihe-map.html-65644bc2.js" as="script"><link rel="prefetch" href="/assets/reflex-mechanism.html-730b6ecc.js" as="script"><link rel="prefetch" href="/assets/base01.html-b8159d90.js" as="script"><link rel="prefetch" href="/assets/gc.html-78e30ca8.js" as="script"><link rel="prefetch" href="/assets/jvm-summary.html-19cf52e3.js" as="script"><link rel="prefetch" href="/assets/memory-structure.html-092cdf2f.js" as="script"><link rel="prefetch" href="/assets/how_select.html-0fce8607.js" as="script"><link rel="prefetch" href="/assets/row_format.html-b49a2f47.js" as="script"><link rel="prefetch" href="/assets/index.html-0a6371a2.js" as="script"><link rel="prefetch" href="/assets/buffer_pool.html-09c58395.js" as="script"><link rel="prefetch" href="/assets/how_to_lock.html-588a9ce0.js" as="script"><link rel="prefetch" href="/assets/lock_phantom.html-9ea50dd8.js" as="script"><link rel="prefetch" href="/assets/mysql_lock.html-c5914183.js" as="script"><link rel="prefetch" href="/assets/show_lock.html-7e47deca.js" as="script"><link rel="prefetch" href="/assets/update_index.html-5ccc5429.js" as="script"><link rel="prefetch" href="/assets/2000w.html-8ba18795.js" as="script"><link rel="prefetch" href="/assets/count.html-abdbc509.js" as="script"><link rel="prefetch" href="/assets/index_interview.html-d310526f.js" as="script"><link rel="prefetch" href="/assets/index_issue.html-a56acee1.js" as="script"><link rel="prefetch" href="/assets/index_lose.html-a6d2563a.js" as="script"><link rel="prefetch" href="/assets/page.html-3b9e8680.js" as="script"><link rel="prefetch" href="/assets/why_index_chose_bpuls_tree.html-7fe13894.js" as="script"><link rel="prefetch" href="/assets/index.html-86702603.js" as="script"><link rel="prefetch" href="/assets/how_update.html-b4ad9fe2.js" as="script"><link rel="prefetch" href="/assets/mvcc.html-b5da16c2.js" as="script"><link rel="prefetch" href="/assets/phantom.html-862a6645.js" as="script"><link rel="prefetch" href="/assets/404.html-ff05e360.js" as="script"><link rel="prefetch" href="/assets/index.html-e0e53856.js" as="script"><link rel="prefetch" href="/assets/index.html-45a39d32.js" as="script"><link rel="prefetch" href="/assets/index.html-6fdec1e3.js" as="script"><link rel="prefetch" href="/assets/index.html-6f9866c1.js" as="script"><link rel="prefetch" href="/assets/index.html-faa4a099.js" as="script"><link rel="prefetch" href="/assets/index.html-db8cb6e5.js" as="script"><link rel="prefetch" href="/assets/index.html-ff07bca7.js" as="script"><link rel="prefetch" href="/assets/index.html-72aa96db.js" as="script"><link rel="prefetch" href="/assets/index.html-6c9e86dd.js" as="script"><link rel="prefetch" href="/assets/index.html-c0ad9ee8.js" as="script"><link rel="prefetch" href="/assets/index.html-7c3f05de.js" as="script"><link rel="prefetch" href="/assets/index.html-e072d534.js" as="script"><link rel="prefetch" href="/assets/index.html-9171ad8f.js" as="script"><link rel="prefetch" href="/assets/index.html-47b378e1.js" as="script"><link rel="prefetch" href="/assets/index.html-e52d7f00.js" as="script"><link rel="prefetch" href="/assets/index.html-bb50baec.js" as="script"><link rel="prefetch" href="/assets/index.html-25a9ea02.js" as="script"><link rel="prefetch" href="/assets/index.html-1f90675d.js" as="script"><link rel="prefetch" href="/assets/index.html-146f7b02.js" as="script"><link rel="prefetch" href="/assets/waline-meta-a31b78ed.js" as="script"><link rel="prefetch" href="/assets/component-38095a60.js" as="script"><link rel="prefetch" href="/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/assets/index-b03bef79.js" as="script"><link rel="prefetch" href="/assets/flowchart-35969cab.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-c1ae7be1.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-0191f9da.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ab04f0b1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-3089f6c6.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-36cd6c3c.js" as="script"><link rel="prefetch" href="/assets/SearchResult-112fac4f.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="brand"><img class="logo light" src="/aowu.gif" alt="MonsterCat"><img class="logo dark" src="/logo.png" alt="MonsterCat"><span class="site-name hide-in-pad">MonsterCat</span></a><!--]--><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!--[--><!--[--><button type="button" class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!--[--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/home.html" class="nav-link" aria-label="首页"><span class="font-icon icon iconfont icon-home" style=""></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="计算机基础"><span class="title"><span class="font-icon icon iconfont icon-computer" style=""></span>计算机基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/computer/data-structure/" class="nav-link" aria-label="数据结构"><span class="font-icon icon iconfont icon-data-structure" style=""></span>数据结构<!----></a></li><li class="dropdown-item"><a href="/computer/network/" class="nav-link" aria-label="计算机网络"><span class="font-icon icon iconfont icon-network" style=""></span>计算机网络<!----></a></li><li class="dropdown-item"><a href="/computer/os/" class="nav-link" aria-label="操作系统"><span class="font-icon icon iconfont icon-os" style=""></span>操作系统<!----></a></li><li class="dropdown-item"><a href="/computer/composition-principle/" class="nav-link" aria-label="计算机组成原理"><span class="font-icon icon iconfont icon-composition-principle" style=""></span>计算机组成原理<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Java相关"><span class="title"><span class="font-icon icon iconfont icon-java" style=""></span>Java相关</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java基础</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/base/object-oriented/" class="nav-link" aria-label="面向对象基础"><span class="font-icon icon iconfont icon-oo" style=""></span>面向对象基础<!----></a></li><li class="dropdown-subitem"><a href="/java/base/jihe/" class="nav-link" aria-label="集合"><span class="font-icon icon iconfont icon-tool" style=""></span>集合<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>Java进阶</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/senior/jvm/" class="nav-link" aria-label="JVM"><span class="font-icon icon iconfont icon-jvm" style=""></span>JVM<!----></a></li><li class="dropdown-subitem"><a href="/java/senior/juc/" class="nav-link" aria-label="并发编程"><span class="font-icon icon iconfont icon-juc" style=""></span>并发编程<!----></a></li><li class="dropdown-subitem"><a href="/java/senior/netty/" class="nav-link" aria-label="网络编程"><span class="font-icon icon iconfont icon-io" style=""></span>网络编程<!----></a></li><li class="dropdown-subitem"><a href="/java/senior/new-features/" class="nav-link" aria-label="新特性"><span class="font-icon icon iconfont icon-new-features" style=""></span>新特性<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="开发基础与框架"><span class="title"><span class="font-icon icon iconfont icon-frame" style=""></span>开发基础与框架</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frame/spring/" class="nav-link" aria-label="Spring"><span class="font-icon icon iconfont icon-spring" style=""></span>Spring<!----></a></li><li class="dropdown-item"><a href="/frame/springMvc/" class="nav-link" aria-label="SpringMvc"><span class="font-icon icon iconfont icon-spring" style=""></span>SpringMvc<!----></a></li><li class="dropdown-item"><a href="/frame/springBoot/" class="nav-link" aria-label="SpringBoot"><span class="font-icon icon iconfont icon-spring" style=""></span>SpringBoot<!----></a></li><li class="dropdown-item"><a href="/frame/class-libraries/" class="nav-link" aria-label="常用类库"><span class="font-icon icon iconfont icon-class-libraries" style=""></span>常用类库<!----></a></li><li class="dropdown-item"><a href="/frame/test/" class="nav-link" aria-label="单元测试"><span class="font-icon icon iconfont icon-test" style=""></span>单元测试<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="数据库"><span class="title"><span class="font-icon icon iconfont icon-sql" style=""></span>数据库</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/sql/mysql/" class="nav-link active" aria-label="MySQL"><span class="font-icon icon iconfont icon-mysql-base" style=""></span>MySQL<!----></a></li><li class="dropdown-item"><a href="/sql/redis/" class="nav-link" aria-label="Redis"><span class="font-icon icon iconfont icon-redis" style=""></span>Redis<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="消息队列"><span class="title"><span class="font-icon icon iconfont icon-mq" style=""></span>消息队列</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/mq/rocketmq/" class="nav-link" aria-label="RocketMQ"><span class="font-icon icon iconfont icon-rocketmq" style=""></span>RocketMQ<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="进阶"><span class="title"><span class="font-icon icon iconfont icon-cloud" style=""></span>进阶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>微服务</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud/cloud/SpringCloud-Ali/" class="nav-link" aria-label="SpringCloud"><span class="font-icon icon iconfont icon-SpringCloudAlibaba" style=""></span>SpringCloud<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>分布式架构</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud/distributed-architecture/drds/" class="nav-link" aria-label="分布式数据库"><span class="font-icon icon iconfont icon-drds" style=""></span>分布式数据库<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>持续集成与容器化</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud/docker/jvm/" class="nav-link" aria-label="Docker"><span class="font-icon icon iconfont icon-docker" style=""></span>Docker<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="常用工具/资料"><span class="title"><span class="font-icon icon iconfont icon-mq" style=""></span>常用工具/资料</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/mq/development-tool/" class="nav-link" aria-label="开发工具"><span class="font-icon icon iconfont icon-dev-tool" style=""></span>开发工具<!----></a></li><li class="dropdown-item"><a href="/mq/books/" class="nav-link" aria-label="技术书籍"><span class="font-icon icon iconfont icon-book" style=""></span>技术书籍<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="网站相关"><span class="title"><span class="font-icon icon iconfont icon-about" style=""></span>网站相关</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/about/author" class="nav-link" aria-label="关于作者"><span class="font-icon icon iconfont icon-author" style=""></span>关于作者<!----></a></li><li class="dropdown-item"><a href="/about/plan" class="nav-link" aria-label="更新计划"><span class="font-icon icon iconfont icon-plan" style=""></span>更新计划<!----></a></li><li class="dropdown-item"><a href="/about/recollect" class="nav-link" aria-label="拾忆"><span class="font-icon icon iconfont icon-plan" style=""></span>拾忆<!----></a></li></ul></button></div></div></nav><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><div class="nav-item"><a class="repo-link" href="https://github.com/MyMonsterCat/note" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">写在前面</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">一、基础篇</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">二、索引篇</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">三、事务篇</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active" type="button"><!----><span class="title">四、锁篇</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/sql/mysql/lock/mysql_lock.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL 有哪些锁？"><!---->MySQL 有哪些锁？<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sql/mysql/lock/how_to_lock.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL 是怎么加锁的？"><!---->MySQL 是怎么加锁的？<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sql/mysql/lock/update_index.html" class="nav-link sidebar-link sidebar-page" aria-label="update 没加索引会锁全表?"><!---->update 没加索引会锁全表?<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/sql/mysql/lock/lock_phantom.html" class="nav-link sidebar-link sidebar-page" aria-label="MySQL 记录锁+间隙锁可以防止删除操作而导致的幻读吗？"><!---->MySQL 记录锁+间隙锁可以防止删除操作而导致的幻读吗？<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/sql/mysql/lock/deadlock.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="MySQL 死锁了，怎么办？"><!---->MySQL 死锁了，怎么办？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#死锁的发生" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="死锁的发生"><!---->死锁的发生<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#为什么会产生死锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="为什么会产生死锁？"><!---->为什么会产生死锁？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#insert-语句是怎么加行级锁的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Insert 语句是怎么加行级锁的？"><!---->Insert 语句是怎么加行级锁的？<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#_1、记录之间加有间隙锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1、记录之间加有间隙锁"><!---->1、记录之间加有间隙锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#_2、遇到唯一键冲突" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2、遇到唯一键冲突"><!---->2、遇到唯一键冲突<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#如何避免死锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="如何避免死锁？"><!---->如何避免死锁？<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/sql/mysql/lock/show_lock.html" class="nav-link sidebar-link sidebar-page" aria-label="字节面试：加了什么锁，导致死锁的？"><!---->字节面试：加了什么锁，导致死锁的？<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">五、日志篇</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable" type="button"><!----><span class="title">六、内存篇</span><span class="arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->MySQL 死锁了，怎么办？</h1><!----><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#死锁的发生" class="router-link-active router-link-exact-active toc-link level2">死锁的发生</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#为什么会产生死锁" class="router-link-active router-link-exact-active toc-link level2">为什么会产生死锁？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#insert-语句是怎么加行级锁的" class="router-link-active router-link-exact-active toc-link level2">Insert 语句是怎么加行级锁的？</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#_1、记录之间加有间隙锁" class="router-link-active router-link-exact-active toc-link level3">1、记录之间加有间隙锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#_2、遇到唯一键冲突" class="router-link-active router-link-exact-active toc-link level3">2、遇到唯一键冲突</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/sql/mysql/lock/deadlock.html#如何避免死锁" class="router-link-active router-link-exact-active toc-link level2">如何避免死锁？</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="mysql-死锁了-怎么办" tabindex="-1"><a class="header-anchor" href="#mysql-死锁了-怎么办" aria-hidden="true">#</a> MySQL 死锁了，怎么办？</h1><p>说个很早之前自己遇到过数据库死锁问题。</p><p>有个业务主要逻辑就是新增订单、修改订单、查询订单等操作。然后因为订单是不能重复的，所以当时在新增订单的时候做了幂等性校验，做法就是在新增订单记录之前，先通过 <code>select ... for update</code> 语句查询订单是否存在，如果不存在才插入订单记录。</p><p>而正是因为这样的操作，当业务量很大的时候，就可能会出现死锁。</p><p>接下来跟大家聊下<strong>为什么会发生死锁，以及怎么避免死锁</strong>。</p><h2 id="死锁的发生" tabindex="-1"><a class="header-anchor" href="#死锁的发生" aria-hidden="true">#</a> 死锁的发生</h2><p>本次案例使用存储引擎 Innodb，隔离级别为可重复读（RR）。</p><p>接下来，我用实战的方式来带大家看看死锁是怎么发生的。</p><p>我建了一张订单表，其中 id 字段为主键索引，order_no 字段普通索引，也就是非唯一索引：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_order<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_no<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_date<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>index_order<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>order_no<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，先 <code>t_order</code> 表里现在已经有了 6 条记录：</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041529810.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>假设这时有两事务，一个事务要插入订单 1007 ，另外一个事务要插入订单 1008，因为需要对订单做幂等性校验，所以两个事务先要查询该订单是否存在，不存在才插入记录，过程如下：</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530150.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，两个事务都陷入了等待状态（前提没有打开死锁检测），也就是发生了死锁，因为都在相互等待对方释放锁。</p><p>这里在查询记录是否存在的时候，使用了 <code>select ... for update</code> 语句，目的为了防止事务执行的过程中，有其他事务插入了记录，而出现幻读的问题。</p><p>如果没有使用 <code>select ... for update</code> 语句，而使用了单纯的 select 语句，如果是两个订单号一样的请求同时进来，就会出现两个重复的订单，有可能出现幻读，如下图：</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530775.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="为什么会产生死锁" tabindex="-1"><a class="header-anchor" href="#为什么会产生死锁" aria-hidden="true">#</a> 为什么会产生死锁？</h2><p>可重复读隔离级别下，是存在幻读的问题。</p><p><strong>Innodb 引擎为了解决「可重复读」隔离级别下的幻读问题，就引出了 next-key 锁</strong>，它是记录锁和间隙锁的组合。</p><ul><li>Record Lock，记录锁，锁的是记录本身；</li><li>Gap Lock，间隙锁，锁的就是两个值之间的空隙，以防止其他事务在这个空隙间插入新的数据，从而避免幻读现象。</li></ul><p>普通的 select 语句是不会对记录加锁的，因为它是通过 MVCC 的机制实现的快照读，如果要在查询时对记录加行锁，可以使用下面这两个方式：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token comment">//对读取的记录加共享锁</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">//锁释放</span>

<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token comment">//对读取的记录加排他锁</span>
<span class="token keyword">select</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">//锁释放</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>行锁的释放时机是在事务提交（commit）后，锁就会被释放，并不是一条语句执行完就释放行锁。</p><p>比如，下面事务 A 查询语句会锁住 <code>(2, +∞]</code> 范围的记录，然后期间如果有其他事务在这个锁住的范围插入数据就会被阻塞。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530130.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>next-key 锁的加锁规则其实挺复杂的，在一些场景下会退化成记录锁或间隙锁，我之前也写一篇加锁规则，详细可以看这篇：<a href="https://xiaolincoding.com/mysql/lock/how_to_lock.html" target="_blank" rel="noopener noreferrer">MySQL 是怎么加锁的？<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>需要注意的是，如果 update 语句的 where 条件没有用到索引列，那么就会全表扫描，在一行行扫描的过程中，不仅给行记录加上了行锁，还给行记录两边的空隙也加上了间隙锁，相当于锁住整个表，然后直到事务结束才会释放锁。</p><p>所以在线上千万不要执行没有带索引条件的 update 语句，不然会造成业务停滞，我有个读者就因为干了这个事情，然后被老板教育了一波，详细可以看这篇：<a href="https://xiaolincoding.com/mysql/lock/update_index.html" target="_blank" rel="noopener noreferrer">update 没加索引会锁全表？<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>回到前面死锁的例子。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530378.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>事务 A 在执行下面这条语句的时候：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">select</span> id <span class="token keyword">from</span> t_order <span class="token keyword">where</span> order_no <span class="token operator">=</span> <span class="token number">1007</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>我们可以通过 <code>select * from performance_schema.data_locks\G;</code> 这条语句，查看事务执行 SQL 过程中加了什么锁。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530252.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>从上图可以看到，共加了两个锁，分别是：</p><ul><li>表锁：X 类型的意向锁；</li><li>行锁：X 类型的 next-key 锁；</li></ul><p>这里我们重点关注行锁，图中 LOCK_TYPE 中的 RECORD 表示行级锁，而不是记录锁的意思，通过 LOCK_MODE 可以确认是 next-key 锁，还是间隙锁，还是记录锁：</p><ul><li>如果 LOCK_MODE 为 <code>X</code>，说明是 X 型的 next-key 锁；</li><li>如果 LOCK_MODE 为 <code>X, REC_NOT_GAP</code>，说明是 X 型的记录锁；</li><li>如果 LOCK_MODE 为 <code>X, GAP</code>，说明是 X 型的间隙锁；</li></ul><p><strong>因此，此时事务 A 在二级索引（INDEX_NAME : index_order）上加的是 X 型的 next-key 锁，锁范围是<code>(1006, +∞]</code></strong>。</p><p>next-key 锁的范围 (1006, +∞]，是怎么确定的？</p><p>根据我的经验，如果 LOCK_MODE 是 next-key 锁或者间隙锁，那么 LOCK_DATA 就表示锁的范围最右值，此次的事务 A 的 LOCK_DATA 是 supremum pseudo-record，表示的是 +∞。然后锁范围的最左值是 t_order 表中最后一个记录的 index_order 的值，也就是 1006。因此，next-key 锁的范围 (1006, +∞]。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>有的读者问，<a href="https://xiaolincoding.com/mysql/lock/how_to_lock.html" target="_blank" rel="noopener noreferrer">MySQL 是怎么加锁的？<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>这篇文章讲非唯一索引等值查询时，说「当查询的记录不存在时，加 next-key lock，然后会退化为间隙锁」。为什么上面事务 A 的 next-key lock 并没有退化为间隙锁？</p><p>如果表中最后一个记录的 order_no 为 1005，那么等值查询 order_no = 1006（不存在），就是 next key lock，如上面事务 A 的情况。</p><p>如果表中最后一个记录的 order_no 为 1010，那么等值查询 order_no = 1006（不存在），就是间隙锁，比如下图：</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530092.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></div><p>当事务 B 往事务 A next-key 锁的范围 (1006, +∞] 里插入 id = 1008 的记录就会被锁住：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">Insert</span> <span class="token keyword">into</span> t_order <span class="token punctuation">(</span>order_no<span class="token punctuation">,</span> create_date<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1008</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>因为当我们执行以下插入语句时，会在插入间隙上获取插入意向锁，* <em>而插入意向锁与间隙锁是冲突的，所以当其它事务持有该间隙的间隙锁时，需要等待其它事务释放间隙锁之后，才能获取到插入意向锁。而间隙锁与间隙锁之间是兼容的，所以所以两个事务中 <code>select ... for update</code> 语句并不会相互影响</em>*。</p><p>案例中的事务 A 和事务 B 在执行完后 <code>select ... for update</code> 语句后都持有范围为<code>(1006,+∞]</code>的next-key 锁，而接下来的插入操作为了获取到插入意向锁，都在等待对方事务的间隙锁释放，于是就造成了循环等待，导致死锁。</p><blockquote><p>为什么间隙锁与间隙锁之间是兼容的？</p></blockquote><p>在MySQL官网上还有一段非常关键的描述：</p><p><em>Gap locks in InnoDB are “purely inhibitive”, which means that their only purpose is to prevent other transactions from Inserting to the gap. Gap locks can co-exist. A gap lock taken by one transaction does not prevent another transaction from taking a gap lock on the same gap. There is no difference between shared and exclusive gap locks. They do not conflict with each other, and they perform the same function.</em></p><p><strong>间隙锁的意义只在于阻止区间被插入</strong>，因此是可以共存的。**一个事务获取的间隙锁不会阻止另一个事务获取同一个间隙范围的间隙锁 **，共享和排他的间隙锁是没有区别的，他们相互不冲突，且功能相同，即两个事务可以同时持有包含共同间隙的间隙锁。</p><p>这里的共同间隙包括两种场景：</p><ul><li>其一是两个间隙锁的间隙区间完全一样；</li><li>其二是一个间隙锁包含的间隙区间是另一个间隙锁包含间隙区间的子集。</li></ul><p>但是有一点要注意，<strong>next-key lock 是包含间隙锁+记录锁的，如果一个事务获取了 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，是会被阻塞的</strong>。</p><p>比如，一个事务持有了范围为 (1, 10] 的 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，就会被阻塞。</p><p>虽然相同范围的间隙锁是多个事务相互兼容的，但对于记录锁，我们是要考虑 X 型与 S 型关系。X 型的记录锁与 X 型的记录锁是冲突的，比如一个事务执行了 select ... where id = 1 for update，后一个事务在执行这条语句的时候，就会被阻塞的。</p><p>但是还要注意！对于这种范围为 (1006, +∞] 的 next-key lock，两个事务是可以同时持有的，不会冲突。因为 +∞ 并不是一个真实的记录，自然就不需要考虑 X 型与 S 型关系。</p><blockquote><p>插入意向锁是什么？</p></blockquote><p>注意！插入意向锁名字虽然有意向锁，但是它并不是意向锁，它是一种特殊的间隙锁。</p><p>在MySQL的官方文档中有以下重要描述：</p><p>*An Insert intention lock is a type of gap lock set by Insert operations prior to row Insertion. This lock signals the intent to Insert in such a way that multiple transactions Inserting into the same index gap need not wait for each other if they are not Inserting at the same position within the gap. Suppose that there are index records with values of 4 and</p><ol start="7"><li>Separate transactions that attempt to Insert values of 5 and 6, respectively, each lock the gap between 4 and 7 with Insert intention locks prior to obtaining the exclusive lock on the Inserted row, but do not block each other because the rows are nonconflicting.*</li></ol><p>这段话表明尽管<strong>插入意向锁是一种特殊的间隙锁，但不同于间隙锁的是，该锁只用于并发插入操作</strong>。</p><p>如果说间隙锁锁住的是一个区间，那么「插入意向锁」锁住的就是一个点。因而从这个角度来说，插入意向锁确实是一种特殊的间隙锁。</p><p>插入意向锁与间隙锁的另一个非常重要的差别是：尽管「插入意向锁」也属于间隙锁，但两个事务却不能在同一时间内，一个拥有间隙锁，另一个拥有该间隙区间内的插入意向锁（当然，插入意向锁如果不在间隙锁区间内则是可以的）。</p><p>另外，我补充一点，插入意向锁的生成时机：</p><ul><li>每插入一条新记录，都需要看一下待插入记录的下一条记录上是否已经被加了间隙锁，如果已加间隙锁，此时会生成一个插入意向锁，然后锁的状态设置为等待状态（ <em>PS：MySQL 加锁时，是先生成锁结构，然后设置锁的状态，如果锁状态是等待状态，并不是意味着事务成功获取到了锁，只有当锁状态为正常状态时，才代表事务成功获取到了锁</em> ），现象就是 Insert 语句会被阻塞。</li></ul><h2 id="insert-语句是怎么加行级锁的" tabindex="-1"><a class="header-anchor" href="#insert-语句是怎么加行级锁的" aria-hidden="true">#</a> Insert 语句是怎么加行级锁的？</h2><p>Insert 语句在正常执行时是不会生成锁结构的，它是靠聚簇索引记录自带的 trx_id 隐藏列来作为<strong>隐式锁</strong>来保护记录的。</p><blockquote><p>什么是隐式锁？</p></blockquote><p>当事务需要加锁的时，如果这个锁不可能发生冲突，InnoDB会跳过加锁环节，这种机制称为隐式锁。隐式锁是 InnoDB 实现的一种延迟加锁机制，其特点是只有在可能发生冲突时才加锁，从而减少了锁的数量，提高了系统整体性能。</p><p>隐式锁就是在 Insert 过程中不加锁，只有在特殊情况下，才会将隐式锁转换为显式锁，这里我们列举两个场景。</p><ul><li>如果记录之间加有间隙锁，为了避免幻读，此时是不能插入记录的；</li><li>如果 Insert 的记录和已有记录存在唯一键冲突，此时也不能插入记录；</li></ul><h3 id="_1、记录之间加有间隙锁" tabindex="-1"><a class="header-anchor" href="#_1、记录之间加有间隙锁" aria-hidden="true">#</a> 1、记录之间加有间隙锁</h3><p>每插入一条新记录，都需要看一下待插入记录的下一条记录上是否已经被加了间隙锁，如果已加间隙锁，此时会生成一个插入意向锁，然后锁的状态设置为等待状态（ <em>PS：MySQL 加锁时，是先生成锁结构，然后设置锁的状态，如果锁状态是等待状态，并不是意味着事务成功获取到了锁，只有当锁状态为正常状态时，才代表事务成功获取到了锁</em> ），现象就是 Insert 语句会被阻塞。</p><p>举个例子，现在 t_order 表中，只有这些数据，<strong>order_no 是二级索引</strong>。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530005.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>现在，事务 A 执行了下面这条语句。</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 事务 A</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_order <span class="token keyword">where</span> order_no <span class="token operator">=</span> <span class="token number">1006</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，我们执行 <code>select * from performance_schema.data_locks\G;</code> 语句 ，确定事务 A 加了什么类型的锁，这里只关注在记录上加锁的类型。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530170.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>本次的例子加的是 next-key 锁（记录锁+间隙锁），锁范围是<code>（1005, +∞]</code>。</p><p>然后，有个事务 B 在这个间隙锁中，插入了一个记录，那么此时该事务 B 就会被阻塞：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment"># 事务 B 插入一条记录</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> t_order<span class="token punctuation">(</span>order_no<span class="token punctuation">,</span> create_date<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1010</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">### 阻塞状态。。。。</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，我们执行 <code>select * from performance_schema.data_locks\G;</code> 语句 ，确定事务 B 加了什么类型的锁，这里只关注在记录上加锁的类型。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530909.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，事务 B 的状态为等待状态（LOCK_STATUS: WAITING），因为向事务 A 生成的 next-key 锁（记录锁+间隙锁）范围<code>（1005, +∞]</code> 中插入了一条记录，所以事务 B 的插入操作生成了一个插入意向锁（<code>LOCK_MODE: X,INSERT_INTENTION </code>），锁的状态是等待状态，意味着事务 B 并没有成功获取到插入意向锁，因此事务 B 发生阻塞。</p><h3 id="_2、遇到唯一键冲突" tabindex="-1"><a class="header-anchor" href="#_2、遇到唯一键冲突" aria-hidden="true">#</a> 2、遇到唯一键冲突</h3><p>如果在插入新记录时，插入了一个与「已有的记录的主键或者唯一二级索引列值相同」的记录（不过可以有多条记录的唯一二级索引列的值同时为NULL，这里不考虑这种情况），此时插入就会失败，然后对于这条记录加上了 <strong>S 型的锁</strong>。</p><p>至于是行级锁的类型是记录锁，还是 next-key 锁，跟是「主键冲突」还是「唯一二级索引冲突」有关系。</p><p>如果主键索引重复：</p><ul><li>当隔离级别为<strong>读已提交</strong>时，插入新记录的事务会给已存在的主键值重复的聚簇索引记录<strong>添加 S 型记录锁</strong>。</li><li>当隔离级别是<strong>可重复读</strong>（默认隔离级别），插入新记录的事务会给已存在的主键值重复的聚簇索引记录<strong>添加 S 型记录锁</strong>。</li></ul><p>如果唯一二级索引列重复：</p><ul><li><strong>不论是哪个隔离级别</strong>，插入新记录的事务都会给已存在的二级索引列值重复的二级索引记录<strong>添加 S 型 next-key 锁</strong> 。对的，没错，即使是读已提交隔离级别也是加 next-key 锁，这是读已提交隔离级别中为数不多的给记录添加间隙锁的场景。至于为什么要加 next-key 锁，我也没找到合理的解释。</li></ul><h4 id="主键索引冲突" tabindex="-1"><a class="header-anchor" href="#主键索引冲突" aria-hidden="true">#</a> 主键索引冲突</h4><p>下面举个「主键冲突」的例子，MySQL 8.0 版本，事务隔离级别为可重复读（默认隔离级别）。</p><p>t_order 表中的 id 字段为主键索引，并且已经存在 id 值为 5 的记录，此时有个事务，插入了一条 id 为 5 的记录，就会报主键索引冲突的错误。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530556.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>但是除了报错之外，还做一个很重要的事情，就是对 id 为 5 的这条记录加上了 <strong>S 型的记录锁</strong>。</p><p>可以执行 <code>select * from performance_schema.data_locks\G;</code> 语句，确定事务加了什么锁。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530838.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，主键索引为 5 （LOCK_DATA）的这条记录中加了锁类型为 S 型的记录锁。注意，这里 LOCK_TYPE 中的 RECORD 表示行级锁，而不是记录锁的意思。如果是 S 型记录锁的话，LOCK_MODE 会显示 <code>S, REC_NOT_GAP</code>。</p><p>所以，在隔离级别是「可重复读」的情况下，如果在插入数据的时候，发生了主键索引冲突，插入新记录的事务会给已存在的主键值重复的聚簇索引记录 <strong>添加 S 型记录锁</strong>。</p><h4 id="唯一二级索引冲突" tabindex="-1"><a class="header-anchor" href="#唯一二级索引冲突" aria-hidden="true">#</a> 唯一二级索引冲突</h4><p>下面举个「唯一二级索引冲突」的例子，MySQL 8.0 版本，事务隔离级别为可重复读（默认隔离级别）。</p><p>t_order 表中的 order_no 字段为唯一二级索引，并且已经存在 order_no 值为 1001 的记录，此时事务 A，插入了 order_no 为 1001 的记录，就出现了报错。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530711.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>但是除了报错之外，还做一个很重要的事情，就是对 order_no 值为 1001 这条记录加上了 <strong>S 型的 next-key 锁</strong>。</p><p>我们可以执行 <code>select * from performance_schema.data_locks\G;</code> 语句 ，确定事务加了什么类型的锁，这里只关注在记录上加锁的类型。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530414.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可以看到，<strong>index_order 二级索引加了 S 型的 next-key 锁，范围是(-∞, 1001]</strong>。注意，这里 LOCK_TYPE 中的 RECORD 表示行级锁，而不是记录锁的意思。如果是记录锁的话，LOCK_MODE 会显示 <code>S, REC_NOT_GAP</code>。</p><p>此时，事务 B 执行了 select * from t_order where order_no = 1001 for update; 就会阻塞，因为这条语句想加 X 型的锁，是与 S 型的锁是冲突的，所以就会被阻塞。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530399.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>我们也可以从 performance_schema.data_locks 这个表中看到，事务 B 的状态（LOCK_STATUS）是等待状态，加锁的类型 X 型的记录锁（LOCK_MODE: X,REC_NOT_GAP ）。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530946.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>上面的案例是针对唯一二级索引重复而插入失败的场景。</p><blockquote><p>接下来，分析两个事务执行过程中，执行了相同的 insert 语句的场景。</p></blockquote><p>现在 t_order 表中，只有这些数据，<strong>order_no 为唯一二级索引</strong>。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530997.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在隔离级别可重复读的情况下，开启两个事务，前后执行相同的 Insert 语句，此时<strong>事务 B 的 Insert 语句会发生阻塞</strong>。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041530750.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>两个事务的加锁过程：</p><ul><li>事务 A 先插入 order_no 为 1006 的记录，可以插入成功，此时对应的唯一二级索引记录被「隐式锁」保护，此时还没有实际的锁结构（执行完这里的时候，你可以看查 performance_schema.data_locks 信息，可以看到这条记录是没有加任何锁的）；</li><li>接着，事务 B 也插入 order_no 为 1006 的记录，由于事务 A 已经插入 order_no 值为 1006 的记录，所以事务 B 在插入二级索引记录时会遇到重复的唯一二级索引列值，此时事务 B 想获取一个 S 型 next-key 锁，但是事务 A 并未提交，<strong>事务 A 插入的 order_no 值为 1006 的记录上的「隐式锁」会变「显示锁」且锁类型为 X 型的记录锁，所以事务 B 向获取 S 型 next-key 锁时会遇到锁冲突，事务 B 进入阻塞状态</strong>。</li></ul><p>我们可以执行 <code>select * from performance_schema.data_locks\G;</code> 语句 ，确定事务加了什么类型的锁，这里只关注在记录上加锁的类型。</p><p>先看事务 A 对 order_no 为 1006 的记录加了什么锁？</p><p>从下图可以看到，<strong>事务 A 对 order_no 为 1006 记录加上了类型为 X 型的记录锁</strong>（<em>注意，这个是在执行事务 B 之后才产生的锁，没执行事务 B 之前，该记录还是隐式锁</em>）。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041531697.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>然后看事务 B 想对 order_no 为 1006 的记录加什么锁？</p><p>从下图可以看到，<strong>事务 B 想对 order_no 为 1006 的记录加 S 型的 next-key 锁，但是由于事务 A 在该记录上持有了 X 型的记录锁，这两个锁是冲突的，所以导致事务 B 处于等待状态</strong>。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041531143.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>从这个实验可以得知，并发多个事务的时候，第一个事务插入的记录，并不会加锁，而是会用隐式锁保护唯一二级索引的记录。</p><p>但是当第一个事务还未提交的时候，有其他事务插入了与第一个事务相同的记录，第二个事务就会<strong>被阻塞</strong>，* <em>因为此时第一事务插入的记录中的隐式锁会变为显示锁且类型是 X 型的记录锁，而第二个事务是想对该记录加上 S 型的 next-key 锁，X 型与 S 型的锁是冲突的</em>*，所以导致第二个事务会等待，直到第一个事务提交后，释放了锁。</p><p>如果 order_no 不是唯一二级索引，那么两个事务，前后执行相同的 Insert 语句，是不会发生阻塞的，就如前面的这个例子。</p><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041531914.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="如何避免死锁" tabindex="-1"><a class="header-anchor" href="#如何避免死锁" aria-hidden="true">#</a> 如何避免死锁？</h2><p>死锁的四个必要条件：<strong>互斥、占有且等待、不可强占用、循环等待</strong>。只要系统发生死锁，这些条件必然成立，但是只要破坏任意一个条件就死锁就不会成立。</p><p>在数据库层面，有两种策略通过「打破循环等待条件」来解除死锁状态：</p><ul><li><p><strong>设置事务等待锁的超时时间</strong>。当一个事务的等待时间超过该值后，就对这个事务进行回滚，于是锁就释放了，另一个事务就可以继续执行了。在 InnoDB 中，参数 <code>innodb_lock_wait_timeout</code> 是用来设置超时时间的，默认值时 50 秒。</p><p>当发生超时后，就出现下面这个提示：</p></li></ul><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041531343.png" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><ul><li><p><strong>开启主动死锁检测</strong> 。主动死锁检测在发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 <code>innodb_deadlock_detect</code> 设置为 on，表示开启这个逻辑，默认就开启。</p><p>当检测到死锁后，就会出现下面这个提示：</p></li></ul><figure><img src="https://monster-note.oss-cn-hangzhou.aliyuncs.com/img/sql/mysql/202307041531997.png" alt="图片" tabindex="0" loading="lazy"><figcaption>图片</figcaption></figure><p>上面这个两种策略是「当有死锁发生时」的避免方式。</p><p>我们可以回归业务的角度来预防死锁，对订单做幂等性校验的目的是为了保证不会出现重复的订单，那我们可以直接将 order_no 字段设置为唯一索引列，利用它的唯一性来保证订单表不会出现重复的订单，不过有一点不好的地方就是在我们插入一个已经存在的订单记录时就会抛出异常。</p><hr><p>参考资料：</p><ul><li>《MySQL 是怎样运行的？》</li><li><a href="http://mysql.taobao.org/monthly/2020/09/06/" target="_blank" rel="noopener noreferrer">http://mysql.taobao.org/monthly/2020/09/06/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><hr></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/MyMonsterCat/note/edit/main/sql/mysql/lock/deadlock.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1264833435@qq.com">Monster</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/sql/mysql/lock/lock_phantom.html" class="nav-link prev" aria-label="MySQL 记录锁+间隙锁可以防止删除操作而导致的幻读吗？"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->MySQL 记录锁+间隙锁可以防止删除操作而导致的幻读吗？</div></a><a href="/sql/mysql/lock/show_lock.html" class="nav-link next" aria-label="字节面试：加了什么锁，导致死锁的？"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">字节面试：加了什么锁，导致死锁的？<!----></div></a></nav><div class="waline-wrapper" id="comment" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  字</div><button type="button" class="wl-btn">登录</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v2.15.4</div></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href="https://beian.miit.gov.cn" target="_blank"> 鲁ICP备2021006500号</a> | <a target="_blank" href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43010402000915" ><img src="/beian.png" style="padding: 0 5px" alt="湘公网安备 43010402000915号"/>湘公网安备 43010402000915号</a></div><div class="copyright">MIT Licensed | Copyright © 2020-present Monster</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-06863dc2.js" defer></script>
  </body>
</html>
